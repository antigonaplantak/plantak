name: CI

on:
  push:
    branches: ["main", "master", "develop"]
  pull_request:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
          POSTGRES_DB: plantak
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U app -d plantak"
          --health-interval=2s
          --health-timeout=3s
          --health-retries=30

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=2s
          --health-timeout=3s
          --health-retries=30

    env:
      NODE_ENV: test
      PORT: 3000
      DATABASE_URL: postgresql://app:app@localhost:5432/plantak?schema=public
      REDIS_URL: redis://localhost:6379
      JWT_ACCESS_SECRET: ci_access_secret
      JWT_REFRESH_SECRET: ci_refresh_secret
      JWT_ACCESS_TTL_MIN: 15
      JWT_REFRESH_TTL_DAYS: 30

      # optional smoke creds (only if your /auth/login supports it)
      SMOKE_EMAIL: demo@plantak.local
      SMOKE_PASSWORD: DemoPass123!

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Prisma generate
        run: |
          if [ -f prisma/schema.prisma ]; then
            npx prisma generate
          else
            echo "No prisma/schema.prisma - skipping"
          fi

      - name: Prisma migrate
        run: |
          if [ -f prisma/schema.prisma ]; then
            npx prisma migrate deploy || npx prisma migrate dev --name ci_init
          else
            echo "No prisma/schema.prisma - skipping"
          fi

      - name: Lint (if exists)
        run: |
          if npm run | grep -q "lint"; then npm run lint; else echo "No lint script"; fi

      - name: Unit tests (if exists)
        run: |
          if npm run | grep -q "test"; then npm test; else echo "No test script"; fi

      - name: Build (if exists)
        run: |
          if npm run | grep -q "build"; then npm run build; else echo "No build script"; fi

      - name: Start API in background (if start exists)
        run: |
          if npm run | grep -q "start"; then
            nohup npm run start --silent >/tmp/app.log 2>&1 &
            sleep 2
            echo "API started (log: /tmp/app.log)"
          else
            echo "No start script"
          fi

      - name: Go-live smoke check (if script exists)
        run: |
          if [ -f scripts/go-live-check.sh ]; then
            chmod +x scripts/go-live-check.sh
            ./scripts/go-live-check.sh || true
          else
            echo "No scripts/go-live-check.sh found"
          fi
